<!DOCTYPE html>
<html>

<head>
  <!-- Basic -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Mobile Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Site Metas -->
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />

  <title>Auditoría de Puntos - Admin</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/logopequeño.png') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- bootstrap core css -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.css') }}">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Enlace a los archivos JS de Bootstrap y Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

  <!-- fonts style -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,700|Roboto:400,700&display=swap" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- responsive style -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/responsive.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/header-improvements.css') }}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    .admin-container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .search-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .results-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .transaction-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .transaction-table th,
    .transaction-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .transaction-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    .transaction-table tr:hover {
      background-color: #f5f5f5;
    }
    
    .btn-action {
      padding: 5px 10px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-anular {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-corregir {
      background-color: #ffc107;
      color: black;
    }
    
    .status-activo {
      color: #28a745;
      font-weight: bold;
    }
    
    .status-anulado {
      color: #dc3545;
      font-weight: bold;
    }
    
    .status-usado {
      color: #6c757d;
      font-weight: bold;
    }
    
    .points-positive {
      color: #28a745;
    }
    
    .points-negative {
      color: #dc3545;
    }
    
    .client-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    
    .modal-content {
      border-radius: 8px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-control {
      border-radius: 4px;
      border: 1px solid #ced4da;
    }
    
    .alert {
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    /* Mejoras para el botón de buscar */
    .btn-search {
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      letter-spacing: 0.5px;
      padding: 0 20px;
      transition: all 0.2s ease;
    }
    
    .btn-search:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    .btn-search i {
      margin-right: 8px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="hero_area">
    <!-- header section strats -->
    <header class="header_section">
      <div class="container-fluid">
        <nav class="navbar navbar-expand-lg custom_nav-container ">
          <a class="navbar-brand" href="/quesonpuntos">
            <span>
              <img src="{{ url_for('static', filename='images/logopequeño.png') }}" class="imgcelu">
            </span>
          </a>
          <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Navigation Links -->
            <ul class="navbar-nav mx-auto">
              <li class="nav-item">
                <a class="nav-link" href="/quesonpuntos">¿Qué son Puntos?</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/mhistorialcompras">Compras Realizadas</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/admin/auditoria">Auditoría Admin</a>
              </li>
            </ul>
            
            <!-- User Greeting Section -->
            <div class="user-greeting-container">
              <div class="icon-text-container">
                <i class="fa-solid fa-user-shield"></i>
                <span class="fw-bold1">Panel Administrativo</span>
              </div>
            </div>
            
            <!-- User Dropdown -->
            <div class="dropdown">
              <a class="nav-link custom-dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="material-icons custom-icon">account_circle</i>
                <i class="material-icons custom-icon-arrow">arrow_drop_down</i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="custom-dropdown-item" href="/quesonpuntos">Volver a Usuario</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="custom-dropdown-item" href="#" id="customLogoutButton">Cerrar sesión</a></li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="admin-container">
      <h2>Auditoría de Club de Puntos</h2>
      <p class="text-muted">Busca y gestiona transacciones de puntos de clientes</p>

      <!-- Search Section -->
      <div class="search-section">
        <h4>Buscar Cliente</h4>
        <form id="searchForm">
          <div class="row">
            <div class="col-md-8">
              <div class="form-group">
                <label for="documento">Documento del Cliente:</label>
                <input type="text" class="form-control" id="documento" name="documento" 
                       placeholder="Ingrese el número de documento" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>&nbsp;</label>
                <button type="submit" class="btn btn-primary btn-search form-control">
                  <i class="fas fa-search"></i> Buscar
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Results Section -->
      <div class="results-section" id="resultsSection" style="display: none;">
        <!-- Client Info Header with Actions -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Información del Cliente</h4>
          <div>
            <button type="button" class="btn btn-success me-2" onclick="showAddTransactionModal()">
              <i class="fas fa-plus"></i> Agregar Transacción
            </button>
            <button type="button" class="btn btn-info" onclick="refreshTransactions()">
              <i class="fas fa-refresh"></i> Actualizar
            </button>
          </div>
        </div>
        
        <!-- Client Info Content -->
        <div class="client-info" id="clientInfo">
          <!-- Se llena dinámicamente -->
        </div>

        <!-- Transactions Table -->
        <div class="table-responsive">
          <table class="transaction-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Puntos</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th>Vencimiento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <!-- Se llena dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal para Agregar Transacción -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Agregar Transacción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addTransactionForm">
              <input type="hidden" id="modalDocumento" name="documento">
              
              <div class="form-group">
                <label for="tipoTransaccion">Tipo de Transacción:</label>
                <select class="form-control" id="tipoTransaccion" name="tipo" required>
                  <option value="">Seleccione...</option>
                  <option value="ACUMULACION">Acumulación de Puntos</option>
                  <option value="REDENCION">Redención de Puntos</option>
                  <option value="REGALO">Puntos de Regalo</option>
                  <option value="CORRECCION">Corrección</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="puntos">Puntos:</label>
                <input type="number" class="form-control" id="puntos" name="puntos" required>
                <small class="form-text text-muted">Use números negativos para descontar puntos</small>
              </div>
              
              <div class="form-group">
                <label for="descripcion">Descripción:</label>
                <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required
                          placeholder="Describa el motivo de esta transacción"></textarea>
              </div>
              
              <div class="form-group">
                <label for="referencia">Referencia (opcional):</label>
                <input type="text" class="form-control" id="referencia" name="referencia"
                       placeholder="Número de factura, cupón, etc.">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="addTransaction()">Agregar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Anular Transacción -->
    <div class="modal fade" id="cancelTransactionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Anular Transacción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>¿Está seguro que desea anular esta transacción?</p>
            <div id="transactionDetails"></div>
            <div class="form-group mt-3">
              <label for="motivoAnulacion">Motivo de la anulación:</label>
              <textarea class="form-control" id="motivoAnulacion" rows="3" required
                        placeholder="Explique por qué se anula esta transacción"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="confirmCancelTransaction()">Anular</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer" style="margin-top: 50px;">
      <div class="container">
        <div class="row">
          <div class="col-md-12 text-center">
            <p>&copy; 2025 Micelu. Panel de Administración.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{{ url_for('static', filename='js/cerrarsesion.js') }}"></script>

  <script>
    let currentDocumento = '';
    let transactionToCancel = '';

    // Buscar cliente
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const documento = document.getElementById('documento').value.trim();
      if (documento) {
        searchClient(documento);
      }
    });

    function searchClient(documento) {
      currentDocumento = documento;
      
      fetch(`/admin/api/cliente/${documento}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showClientInfo(data.cliente);
            loadTransactions(documento);
            document.getElementById('resultsSection').style.display = 'block';
          } else {
            alert('Cliente no encontrado: ' + data.message);
            document.getElementById('resultsSection').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al buscar cliente');
        });
    }

    function showClientInfo(cliente) {
      const html = `
        <div class="row">
          <div class="col-md-2"><strong>Documento:</strong><br><span style="font-size: 16px; font-weight: 500;">${cliente.documento}</span></div>
          <div class="col-md-3"><strong>Nombre:</strong><br><span style="font-size: 16px; font-weight: 500;">${cliente.nombre}</span></div>
          <div class="col-md-4"><strong>Email:</strong><br><span style="font-size: 16px; font-weight: 500;">${cliente.email || 'N/A'}</span></div>
          <div class="col-md-3"><strong>Puntos Disponibles:</strong><br><span class="badge badge-success" style="font-size: 13px; padding: 6px 10px;">${cliente.puntos_disponibles.toLocaleString()}</span></div>
        </div>
      `;
      document.getElementById('clientInfo').innerHTML = html;
    }

    function loadTransactions(documento) {
      fetch(`/admin/api/transacciones/${documento}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showTransactions(data.transacciones);
          } else {
            alert('Error al cargar transacciones: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cargar transacciones');
        });
    }

    function showTransactions(transacciones) {
      const tbody = document.getElementById('transactionsTableBody');
      tbody.innerHTML = '';

      transacciones.forEach(t => {
        const row = document.createElement('tr');
        
        const puntosClass = t.puntos >= 0 ? 'points-positive' : 'points-negative';
        const statusClass = `status-${t.estado.toLowerCase()}`;
        
        row.innerHTML = `
          <td>${new Date(t.fecha).toLocaleDateString()}</td>
          <td>${t.tipo}</td>
          <td class="${puntosClass}">${t.puntos >= 0 ? '+' : ''}${t.puntos.toLocaleString()}</td>
          <td>${t.descripcion}</td>
          <td class="${statusClass}">${t.estado}</td>
          <td>${t.fecha_vencimiento ? new Date(t.fecha_vencimiento).toLocaleDateString() : 'N/A'}</td>
          <td>
            ${t.estado === 'ACTIVO' ? `
              <button class="btn-action btn-anular" onclick="showCancelModal('${t.id}', '${t.descripcion}', ${t.puntos})">
                Anular
              </button>
            ` : ''}
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function showAddTransactionModal() {
      document.getElementById('modalDocumento').value = currentDocumento;
      const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
      modal.show();
    }

    function addTransaction() {
      const form = document.getElementById('addTransactionForm');
      const formData = new FormData(form);
      
      const data = {
        documento: formData.get('documento'),
        tipo: formData.get('tipo'),
        puntos: parseInt(formData.get('puntos')),
        descripcion: formData.get('descripcion'),
        referencia: formData.get('referencia')
      };

      fetch('/admin/api/agregar_transaccion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Transacción agregada exitosamente');
          bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
          form.reset();
          refreshTransactions();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar transacción');
      });
    }

    function showCancelModal(transactionId, descripcion, puntos) {
      transactionToCancel = transactionId;
      document.getElementById('transactionDetails').innerHTML = `
        <strong>Transacción:</strong> ${descripcion}<br>
        <strong>Puntos:</strong> ${puntos.toLocaleString()}
      `;
      const modal = new bootstrap.Modal(document.getElementById('cancelTransactionModal'));
      modal.show();
    }

    function confirmCancelTransaction() {
      const motivo = document.getElementById('motivoAnulacion').value.trim();
      if (!motivo) {
        alert('Debe ingresar un motivo para la anulación');
        return;
      }

      fetch('/admin/api/anular_transaccion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          transaction_id: transactionToCancel,
          motivo: motivo
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Transacción anulada exitosamente');
          bootstrap.Modal.getInstance(document.getElementById('cancelTransactionModal')).hide();
          document.getElementById('motivoAnulacion').value = '';
          refreshTransactions();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al anular transacción');
      });
    }

    function refreshTransactions() {
      if (currentDocumento) {
        searchClient(currentDocumento);
      }
    }
  </script>
</body>

</html>